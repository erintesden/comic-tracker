<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comic Reading Tracker</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#C4745A">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Comic Tracker">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #F5F0EB;
  --bg-secondary: #EDE6DD;
  --bg-card: #FAF7F4;
  --bg-hover: #F0E8DF;
  --text-primary: #3D3229;
  --text-secondary: #7A6E62;
  --text-muted: #A89E94;
  --accent-terracotta: #C4745A;
  --accent-amber: #D4A053;
  --accent-sage: #8B9E7E;
  --border: #E2D9CF;
  --shadow: rgba(61, 50, 41, 0.08);
  --progress-bg: #E8DFD4;
  --progress-fill: #8B9E7E;
  --checkbox-checked: #C4745A;
  --danger: #C4745A;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  font-family: 'DM Sans', sans-serif;
  background-color: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* ── HEADER ── */
.app-header {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 1px 4px var(--shadow);
}

.header-inner {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
}

.app-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.6rem;
  font-weight: 800;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
  white-space: nowrap;
}

.app-title .icon { font-size: 1.4rem; }

.header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.btn {
  font-family: 'DM Sans', sans-serif;
  font-size: 0.85rem;
  font-weight: 500;
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text-primary);
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.btn:hover {
  background: var(--bg-hover);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px var(--shadow);
}

.btn:active { transform: translateY(0); }

.btn-primary {
  background: var(--accent-terracotta);
  color: #fff;
  border-color: var(--accent-terracotta);
}

.btn-primary:hover { background: #b5664d; border-color: #b5664d; }

.btn-sage {
  background: var(--accent-sage);
  color: #fff;
  border-color: var(--accent-sage);
}

.btn-sage:hover { background: #7a8e6e; border-color: #7a8e6e; }

.btn-small { font-size: 0.78rem; padding: 5px 10px; }

.btn-ghost { background: transparent; border-color: transparent; }
.btn-ghost:hover { background: var(--bg-hover); }

.btn-danger { color: var(--danger); }
.btn-danger:hover { background: #fdf0ed; }

/* ── STATS BAR ── */
.stats-bar {
  max-width: 1200px;
  margin: 0 auto;
  padding: 12px 24px;
  font-size: 0.85rem;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.stats-bar .stat { display: flex; align-items: center; gap: 4px; }
.stats-bar .stat strong { color: var(--text-primary); font-weight: 600; }

/* ── SEARCH SECTION ── */
.search-section {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 24px 16px;
}

.search-row {
  display: flex;
  gap: 10px;
  align-items: stretch;
  flex-wrap: wrap;
}

.search-container {
  position: relative;
  flex: 1;
  min-width: 240px;
}

.search-input {
  width: 100%;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem;
  padding: 10px 16px 10px 40px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--bg-card);
  color: var(--text-primary);
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.search-input:focus {
  border-color: var(--accent-terracotta);
  box-shadow: 0 0 0 3px rgba(196, 116, 90, 0.12);
}

.search-input::placeholder { color: var(--text-muted); }

.search-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  pointer-events: none;
  font-size: 0.95rem;
}

.search-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  box-shadow: 0 8px 24px var(--shadow);
  max-height: 360px;
  overflow-y: auto;
  z-index: 200;
  display: none;
  animation: fadeDropdown 0.2s ease;
}

@keyframes fadeDropdown {
  from { opacity: 0; transform: translateY(-6px); }
  to { opacity: 1; transform: translateY(0); }
}

.search-dropdown.visible { display: block; }

.search-result-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 14px;
  cursor: pointer;
  transition: background 0.15s;
  border-bottom: 1px solid var(--border);
}

.search-result-item:last-child { border-bottom: none; }
.search-result-item:hover { background: var(--bg-hover); }

.search-result-img {
  width: 36px;
  height: 50px;
  object-fit: cover;
  border-radius: 4px;
  background: var(--bg-secondary);
  flex-shrink: 0;
}

.search-result-info { flex: 1; min-width: 0; }

.search-result-title {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.search-result-meta { font-size: 0.78rem; color: var(--text-muted); }

.search-message {
  padding: 16px;
  text-align: center;
  color: var(--text-muted);
  font-size: 0.85rem;
}

.search-loading {
  padding: 20px;
  text-align: center;
  color: var(--text-muted);
}

.search-loading .spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--border);
  border-top-color: var(--accent-terracotta);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  margin-right: 8px;
  vertical-align: middle;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ── MAIN CONTENT ── */
.main-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 24px 40px;
}

/* ── EMPTY STATE ── */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state .empty-icon { font-size: 3.5rem; margin-bottom: 16px; opacity: 0.5; }

.empty-state h2 {
  font-family: 'Playfair Display', serif;
  font-size: 1.5rem;
  margin-bottom: 8px;
  color: var(--text-primary);
}

.empty-state p {
  font-size: 0.95rem;
  margin-bottom: 24px;
  max-width: 400px;
  margin-left: auto;
  margin-right: auto;
}

/* ── CARDS GRID ── */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

@media (max-width: 1100px) { .cards-grid { grid-template-columns: repeat(2, 1fr); } }

@media (max-width: 768px) {
  .cards-grid { grid-template-columns: 1fr; }
  .header-inner { justify-content: center; text-align: center; }
  .search-row { flex-direction: column; }
  .stats-bar { justify-content: center; }
}

/* ── SERIES CARD ── */
.series-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
  transition: transform 0.22s ease, box-shadow 0.22s ease;
  position: relative;
}

.series-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px var(--shadow);
}

.card-header {
  display: flex;
  gap: 12px;
  padding: 16px;
  cursor: pointer;
  user-select: none;
}

.card-cover {
  width: 56px;
  height: 80px;
  object-fit: cover;
  border-radius: 6px;
  background: var(--bg-secondary);
  flex-shrink: 0;
}

.card-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.card-title {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--text-primary);
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 24px;
}

.card-progress-text {
  font-size: 0.78rem;
  color: var(--text-secondary);
  margin-bottom: 6px;
}

.card-progress-bar {
  width: 100%;
  height: 6px;
  background: var(--progress-bg);
  border-radius: 3px;
  overflow: hidden;
}

.card-progress-fill {
  height: 100%;
  background: var(--progress-fill);
  border-radius: 3px;
  transition: width 0.5s ease;
  min-width: 0;
}

/* ── NEXT UNREAD WIDGET (new in v2) ── */
.next-unread-widget {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  background: var(--bg-secondary);
  transition: opacity 0.3s ease;
}

.next-unread-widget.hidden {
  display: none;
}

.next-unread-thumb {
  width: 40px;
  height: 56px;
  object-fit: cover;
  border-radius: 5px;
  background: var(--bg-primary);
  flex-shrink: 0;
  box-shadow: 0 1px 4px var(--shadow);
}

.next-unread-info {
  flex: 1;
  min-width: 0;
}

.next-unread-label {
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  margin-bottom: 2px;
}

.next-unread-title {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.next-unread-mark {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 6px;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.78rem;
  font-weight: 600;
  padding: 7px 14px;
  border-radius: 8px;
  border: 2px solid var(--accent-sage);
  background: transparent;
  color: var(--accent-sage);
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.next-unread-mark:hover {
  background: var(--accent-sage);
  color: #fff;
  transform: scale(1.03);
  box-shadow: 0 2px 8px rgba(139, 158, 126, 0.25);
}

.next-unread-mark:active {
  transform: scale(0.97);
}

.next-unread-mark .check-icon {
  width: 16px;
  height: 16px;
  border-radius: 4px;
  border: 2px solid currentColor;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.next-unread-mark:hover .check-icon {
  background: rgba(255,255,255,0.3);
}

.next-unread-mark .check-icon::after {
  content: '';
  display: block;
  width: 4px;
  height: 7px;
  border: solid currentColor;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
  margin-top: -1px;
}

.all-read-message {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  border-top: 1px solid var(--border);
  background: var(--bg-secondary);
  font-size: 0.82rem;
  color: var(--accent-sage);
  font-weight: 500;
}

.all-read-message.hidden { display: none; }

/* ── CARD TOGGLE ── */
.card-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 16px;
  font-size: 0.78rem;
  color: var(--text-muted);
  cursor: pointer;
  border-top: 1px solid var(--border);
  transition: background 0.15s, color 0.15s;
  user-select: none;
}

.card-toggle:hover {
  background: var(--bg-hover);
  color: var(--text-secondary);
}

.card-toggle .arrow {
  display: inline-block;
  transition: transform 0.3s ease;
  font-size: 0.7rem;
}

.card-toggle .arrow.expanded { transform: rotate(180deg); }

.card-delete {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 28px;
  height: 28px;
  border-radius: 6px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  opacity: 0;
  z-index: 5;
}

.series-card:hover .card-delete { opacity: 1; }

.card-delete:hover { background: #fdf0ed; color: var(--danger); }

/* ── REORDER CONTROLS (new in v2) ── */
.reorder-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  flex-wrap: wrap;
}

.reorder-bar select {
  font-family: 'DM Sans', sans-serif;
  font-size: 0.78rem;
  padding: 4px 8px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--bg-primary);
  color: var(--text-primary);
  outline: none;
  cursor: pointer;
}

.reorder-bar label {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

/* ── ISSUES LIST ── */
.issues-wrapper {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease;
}

.issues-wrapper.expanded { max-height: 2000px; }

.issues-list {
  max-height: 400px;
  overflow-y: auto;
  padding: 0 12px 12px;
}

.issues-list::-webkit-scrollbar { width: 5px; }
.issues-list::-webkit-scrollbar-track { background: transparent; }
.issues-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.issue-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 8px;
  border-radius: 8px;
  transition: background 0.15s;
  min-height: 44px;
}

.issue-row:hover { background: var(--bg-hover); }
.issue-row.read { opacity: 0.55; }

.issue-row.read .issue-text {
  text-decoration: line-through;
  text-decoration-color: var(--text-muted);
}

/* ── CUSTOM CHECKBOX ── */
.issue-checkbox {
  position: relative;
  width: 22px;
  height: 22px;
  flex-shrink: 0;
  cursor: pointer;
}

.issue-checkbox input {
  position: absolute;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
  z-index: 2;
  margin: 0;
}

.issue-checkbox .checkmark {
  position: absolute;
  top: 0;
  left: 0;
  width: 22px;
  height: 22px;
  border: 2px solid var(--border);
  border-radius: 6px;
  background: var(--bg-card);
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.issue-checkbox input:checked + .checkmark {
  background: var(--checkbox-checked);
  border-color: var(--checkbox-checked);
  animation: checkBounce 0.35s ease;
}

.issue-checkbox .checkmark::after {
  content: '';
  display: block;
  width: 5px;
  height: 10px;
  border: solid #fff;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg) scale(0);
  transition: transform 0.2s ease;
  margin-top: -2px;
}

.issue-checkbox input:checked + .checkmark::after { transform: rotate(45deg) scale(1); }

@keyframes checkBounce {
  0% { transform: scale(1); }
  30% { transform: scale(1.25); }
  60% { transform: scale(0.9); }
  100% { transform: scale(1); }
}

.issue-thumb {
  width: 40px;
  height: 56px;
  object-fit: cover;
  border-radius: 4px;
  background: var(--bg-secondary);
  flex-shrink: 0;
}

.issue-text {
  flex: 1;
  font-size: 0.84rem;
  color: var(--text-primary);
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.issue-text .issue-number { font-weight: 600; }

/* ── MODAL ── */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(61, 50, 41, 0.4);
  z-index: 500;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  animation: fadeIn 0.2s ease;
}

.modal-overlay.visible { display: flex; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.modal {
  background: var(--bg-card);
  border-radius: 16px;
  width: 100%;
  max-width: 560px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 16px 48px rgba(61, 50, 41, 0.2);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px 0;
}

.modal-header h2 {
  font-family: 'Playfair Display', serif;
  font-size: 1.3rem;
  font-weight: 700;
}

.modal-close {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }

.modal-body { padding: 20px 24px 24px; }

.form-group { margin-bottom: 16px; }

.form-label {
  display: block;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.form-input {
  width: 100%;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-primary);
  color: var(--text-primary);
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.form-input:focus {
  border-color: var(--accent-terracotta);
  box-shadow: 0 0 0 3px rgba(196, 116, 90, 0.12);
}

.form-input::placeholder { color: var(--text-muted); }

.form-row { display: flex; gap: 10px; align-items: flex-end; }
.form-row .form-group { flex: 1; }

.form-divider {
  border: none;
  border-top: 1px solid var(--border);
  margin: 20px 0;
}

.preview-issues {
  max-height: 250px;
  overflow-y: auto;
  margin-top: 12px;
}

.preview-issue {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.84rem;
  color: var(--text-primary);
}

.preview-issue:hover { background: var(--bg-hover); }

.preview-issue .remove-issue {
  margin-left: auto;
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 4px;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 0.85rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.preview-issue .remove-issue:hover { color: var(--danger); background: #fdf0ed; }

.modal-footer {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  padding-top: 8px;
}

/* ── SETTINGS MODAL EXTRAS ── */
.api-key-note {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 6px;
  line-height: 1.5;
}

.api-key-note a { color: var(--accent-terracotta); text-decoration: none; }
.api-key-note a:hover { text-decoration: underline; }

/* ── TOAST ── */
.toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}

.toast {
  background: var(--text-primary);
  color: #fff;
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 0.85rem;
  font-weight: 500;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  animation: toastIn 0.3s ease, toastOut 0.3s ease 2.5s forwards;
  pointer-events: auto;
}

@keyframes toastIn {
  from { opacity: 0; transform: translateY(12px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes toastOut {
  from { opacity: 1; transform: translateY(0) scale(1); }
  to { opacity: 0; transform: translateY(-8px) scale(0.95); }
}

/* ── CONFIRM DIALOG ── */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(61, 50, 41, 0.4);
  z-index: 600;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.confirm-overlay.visible { display: flex; }

.confirm-box {
  background: var(--bg-card);
  border-radius: 14px;
  padding: 24px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 16px 48px rgba(61, 50, 41, 0.2);
  animation: slideUp 0.3s ease;
}

.confirm-box h3 { font-family: 'Playfair Display', serif; margin-bottom: 8px; }
.confirm-box p { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 20px; }
.confirm-actions { display: flex; gap: 10px; justify-content: flex-end; }

/* ── PLACEHOLDER SVG ── */
.placeholder-thumb {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border-radius: 4px;
  flex-shrink: 0;
}

.placeholder-thumb.card-size { width: 56px; height: 80px; border-radius: 6px; }
.placeholder-thumb.issue-size { width: 40px; height: 56px; }
.placeholder-thumb svg { opacity: 0.35; }

#importInput { display: none; }

/* ── MARK READ ANIMATION ── */
@keyframes markReadPulse {
  0% { transform: scale(1); }
  40% { transform: scale(1.04); }
  100% { transform: scale(1); }
}

.next-unread-widget.marking {
  animation: markReadPulse 0.35s ease;
}

/* ── SKIP BUTTON (new in v3) ── */
.next-unread-skip {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 4px;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.72rem;
  font-weight: 600;
  padding: 5px 10px;
  border-radius: 6px;
  border: 1.5px solid var(--accent-amber);
  background: transparent;
  color: var(--accent-amber);
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.next-unread-skip:hover {
  background: var(--accent-amber);
  color: #fff;
  transform: scale(1.03);
  box-shadow: 0 2px 8px rgba(212, 160, 83, 0.25);
}

.next-unread-skip:active {
  transform: scale(0.97);
}

.next-unread-skip .skip-arrow {
  font-size: 0.8rem;
  line-height: 1;
}

/* Skip button in expanded issue rows */
.issue-skip-btn {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 3px;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.7rem;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 5px;
  border: 1.5px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  opacity: 0;
}

.issue-row:hover .issue-skip-btn {
  opacity: 1;
}

.issue-skip-btn:hover {
  border-color: var(--accent-amber);
  color: var(--accent-amber);
  background: rgba(212, 160, 83, 0.08);
}

.issue-skip-btn.is-skipped {
  opacity: 1;
  border-color: var(--accent-amber);
  color: var(--accent-amber);
  background: rgba(212, 160, 83, 0.08);
}

.issue-skip-btn.is-skipped:hover {
  background: rgba(212, 160, 83, 0.18);
}

/* Skipped issue row styling */
.issue-row.skipped {
  opacity: 0.45;
  background: repeating-linear-gradient(
    -45deg,
    transparent,
    transparent 8px,
    rgba(212, 160, 83, 0.04) 8px,
    rgba(212, 160, 83, 0.04) 16px
  );
}

.issue-row.skipped .issue-text {
  font-style: italic;
  color: var(--text-muted);
}

.issue-row.skipped:hover {
  opacity: 0.65;
}

/* Skipped badge next to issue number in expanded list */
.skipped-badge {
  display: inline-block;
  font-size: 0.62rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--accent-amber);
  background: rgba(212, 160, 83, 0.12);
  padding: 1px 5px;
  border-radius: 3px;
  margin-left: 6px;
  vertical-align: middle;
}

/* ── MOBILE TWEAKS ── */
@media (max-width: 768px) {
  .app-header { padding: 12px 16px; }
  .app-title { font-size: 1.3rem; }
  .search-section { padding: 0 16px 12px; }
  .main-content { padding: 0 16px 32px; }
  .stats-bar { padding: 10px 16px; }
  .modal { max-width: 100%; border-radius: 14px; }
  .btn { padding: 8px 12px; font-size: 0.82rem; }
  .toast-container { bottom: 16px; right: 16px; left: 16px; }
  .toast { text-align: center; }
  .issue-checkbox { width: 28px; height: 28px; }
  .issue-checkbox .checkmark { width: 28px; height: 28px; }
  .card-delete { opacity: 1; }
  .next-unread-mark { padding: 8px 12px; }
  .issue-skip-btn { opacity: 1; }
  .next-unread-skip { padding: 6px 10px; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="app-header">
  <div class="header-inner">
    <h1 class="app-title">
      <span class="icon">&#128218;</span> Comic Tracker
    </h1>
    <div class="header-actions">
      <button class="btn btn-ghost" id="btnSettings" title="Settings">&#9881; Settings</button>
      <button class="btn" id="btnExport">&#8681; Export</button>
      <button class="btn" id="btnImport">&#8679; Import</button>
      <input type="file" id="importInput" accept=".json">
    </div>
  </div>
</header>

<!-- STATS -->
<div class="stats-bar" id="statsBar">
  <span class="stat">Tracking <strong id="statSeries">0</strong> series</span>
  <span class="stat">&middot;</span>
  <span class="stat"><strong id="statRead">0</strong>/<strong id="statTotal">0</strong> issues read</span>
</div>

<!-- SEARCH -->
<section class="search-section">
  <div class="search-row">
    <div class="search-container">
      <span class="search-icon">&#128269;</span>
      <input type="text" class="search-input" id="searchInput" placeholder="Search comics or create manually..." autocomplete="off">
      <div class="search-dropdown" id="searchDropdown"></div>
    </div>
    <button class="btn btn-primary" id="btnCreateManual">+ Create Manually</button>
  </div>
</section>

<!-- MAIN -->
<main class="main-content" id="mainContent"></main>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- MANUAL CREATE MODAL -->
<div class="modal-overlay" id="manualModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Create Reading List</h2>
      <button class="modal-close" id="manualModalClose">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Series Name *</label>
        <input type="text" class="form-input" id="manualName" placeholder="e.g. Batman (2016)">
      </div>
      <div class="form-group">
        <label class="form-label">Series Cover Image URL (optional)</label>
        <input type="text" class="form-input" id="manualImage" placeholder="https://...">
      </div>
      <hr class="form-divider">
      <h3 style="font-size:0.95rem;font-weight:600;margin-bottom:12px;color:var(--text-secondary);">Add Issues</h3>
      <div class="form-row" style="margin-bottom:12px;">
        <div class="form-group" style="flex:0 0 80px;">
          <label class="form-label">From #</label>
          <input type="number" class="form-input" id="rangeStart" placeholder="1" min="1">
        </div>
        <div class="form-group" style="flex:0 0 80px;">
          <label class="form-label">To #</label>
          <input type="number" class="form-input" id="rangeEnd" placeholder="25" min="1">
        </div>
        <div class="form-group" style="flex:0 0 auto;align-self:flex-end;">
          <button class="btn btn-sage btn-small" id="btnAddRange">Add Range</button>
        </div>
      </div>
      <div class="form-row" style="margin-bottom:8px;">
        <div class="form-group" style="flex:0 0 70px;">
          <label class="form-label">Issue #</label>
          <input type="text" class="form-input" id="singleNumber" placeholder="#">
        </div>
        <div class="form-group">
          <label class="form-label">Title (optional)</label>
          <input type="text" class="form-input" id="singleTitle" placeholder="Issue title">
        </div>
        <div class="form-group" style="flex:0 0 auto;align-self:flex-end;">
          <button class="btn btn-small" id="btnAddSingle">Add</button>
        </div>
      </div>
      <div class="form-group" style="margin-bottom:4px;">
        <label class="form-label">Cover URL for single issue (optional)</label>
        <input type="text" class="form-input" id="singleCover" placeholder="https://...">
      </div>
      <div class="preview-issues" id="previewIssues"></div>
      <div class="modal-footer">
        <button class="btn" id="manualCancel">Cancel</button>
        <button class="btn btn-primary" id="manualCreate">Create List</button>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="modal-close" id="settingsModalClose">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Comic Vine API Key</label>
        <input type="text" class="form-input" id="apiKeyInput" placeholder="Paste your API key here...">
        <p class="api-key-note">
          Get a free API key at <a href="https://comicvine.gamespot.com/api/" target="_blank" rel="noopener">comicvine.gamespot.com/api</a>.<br>
          Required for searching and importing comics from the API. Without a key, you can still create lists manually.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn" id="settingsCancel">Cancel</button>
        <button class="btn btn-primary" id="settingsSave">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- IMPORT CONFIRM MODAL -->
<div class="confirm-overlay" id="importConfirm">
  <div class="confirm-box">
    <h3>Import Data</h3>
    <p>How would you like to handle existing data?</p>
    <div class="confirm-actions">
      <button class="btn" id="importCancel">Cancel</button>
      <button class="btn btn-sage" id="importMerge">Merge</button>
      <button class="btn btn-primary" id="importReplace">Replace All</button>
    </div>
  </div>
</div>

<!-- DELETE CONFIRM MODAL -->
<div class="confirm-overlay" id="deleteConfirm">
  <div class="confirm-box">
    <h3>Delete List</h3>
    <p id="deleteConfirmText">Are you sure you want to delete this reading list?</p>
    <div class="confirm-actions">
      <button class="btn" id="deleteCancel">Cancel</button>
      <button class="btn btn-primary" id="deleteYes">Delete</button>
    </div>
  </div>
</div>

<script>
/* ════════════════════════════════════════════
   COMIC READING TRACKER v4
   + Removed "Mark All Read/Unread" buttons
   ════════════════════════════════════════════ */

(function() {
  'use strict';

  // ── UUID GENERATOR ──
  function uuid() {
    if (crypto.randomUUID) return crypto.randomUUID();
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
  }

  // ── STATE ──
  const DEFAULT_STATE = { lists: [], settings: { apiKey: '' } };
  let state = loadState();
  let pendingImportData = null;
  let pendingDeleteId = null;
  let manualIssues = [];
  let searchTimeout = null;

  // ── PERSISTENCE ──
  function loadState() {
    try {
      const raw = localStorage.getItem('comic-tracker-data-v3');
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed && Array.isArray(parsed.lists)) {
          if (!parsed.settings) parsed.settings = { apiKey: '' };
          // Ensure each list has a sortOrder field (migration from older versions)
          parsed.lists.forEach(function(list) {
            if (!list.sortOrder) list.sortOrder = 'number-asc';
            // Migrate title sorts to number-asc
            if (list.sortOrder === 'title-asc' || list.sortOrder === 'title-desc') list.sortOrder = 'number-asc';
            // Ensure each issue has a skipped property
            list.issues.forEach(function(iss) {
              if (typeof iss.skipped === 'undefined') iss.skipped = false;
            });
          });
          return parsed;
        }
      }
    } catch (e) { /* ignore */ }
    return JSON.parse(JSON.stringify(DEFAULT_STATE));
  }

  function saveState() {
    try {
      localStorage.setItem('comic-tracker-data-v3', JSON.stringify(state));
    } catch (e) {
      console.error('Failed to save state:', e);
    }
  }

  // ── TOAST ──
  function showToast(msg) {
    const container = document.getElementById('toastContainer');
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    container.appendChild(t);
    setTimeout(function() { t.remove(); }, 3000);
  }

  // ── PLACEHOLDER SVG ──
  function placeholderDataURI(w, h) {
    var svg = '<svg width="'+w+'" height="'+h+'" viewBox="0 0 '+w+' '+h+'" xmlns="http://www.w3.org/2000/svg">' +
      '<rect width="'+w+'" height="'+h+'" fill="#E2D9CF"/>' +
      '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="DM Sans,sans-serif" font-size="'+Math.min(w,h)*0.22+'" fill="#A89E94">No Image</text></svg>';
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }

  function imgWithFallback(src, w, h, cls) {
    if (src) {
      return '<img src="'+escapeAttr(src)+'" width="'+w+'" height="'+h+'" class="'+cls+'" loading="lazy" onerror="this.onerror=null;this.src=\''+placeholderDataURI(w,h)+'\'">';
    }
    return '<img src="'+placeholderDataURI(w,h)+'" width="'+w+'" height="'+h+'" class="'+cls+'" loading="lazy">';
  }

  function escapeHTML(str) {
    var d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
  }

  function escapeAttr(str) {
    return (str || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // ── SORT ISSUES ──
  function getSortedIssues(list) {
    var issues = list.issues.slice();
    var order = list.sortOrder || 'number-asc';

    issues.sort(function(a, b) {
      var na = parseFloat(a.number) || 0;
      var nb = parseFloat(b.number) || 0;
      switch (order) {
        case 'number-desc': return nb - na;
        case 'unread-first':
          if (a.read !== b.read) return a.read ? 1 : -1;
          return na - nb;
        case 'read-first':
          if (a.read !== b.read) return a.read ? -1 : 1;
          return na - nb;
        case 'skipped-first':
          var aSkip = a.skipped ? 1 : 0;
          var bSkip = b.skipped ? 1 : 0;
          if (aSkip !== bSkip) return bSkip - aSkip;
          return na - nb;
        default: // number-asc
          return na - nb;
      }
    });
    return issues;
  }

  // ── FIND NEXT UNREAD (skips issues marked as skipped) ──
  function getNextUnread(list) {
    var byNumber = list.issues.slice().sort(function(a, b) {
      return (parseFloat(a.number) || 0) - (parseFloat(b.number) || 0);
    });
    for (var i = 0; i < byNumber.length; i++) {
      if (!byNumber[i].read && !byNumber[i].skipped) return byNumber[i];
    }
    return null;
  }

  // ── STATS ──
  function updateStats() {
    var seriesCount = state.lists.length;
    var totalIssues = 0, readIssues = 0;
    state.lists.forEach(function(list) {
      totalIssues += list.issues.length;
      readIssues += list.issues.filter(function(i) { return i.read; }).length;
    });
    document.getElementById('statSeries').textContent = seriesCount;
    document.getElementById('statRead').textContent = readIssues;
    document.getElementById('statTotal').textContent = totalIssues;
  }

  // ── RENDER ──
  function render() {
    var main = document.getElementById('mainContent');
    updateStats();

    if (state.lists.length === 0) {
      main.innerHTML =
        '<div class="empty-state">' +
          '<div class="empty-icon">&#128218;</div>' +
          '<h2>No Reading Lists Yet</h2>' +
          '<p>Search for comic series using the Comic Vine API, or create a list manually to start tracking your reading progress.</p>' +
          '<button class="btn btn-primary" onclick="document.getElementById(\'btnCreateManual\').click()">Get Started</button>' +
        '</div>';
      return;
    }

    var html = '<div class="cards-grid">';
    state.lists.forEach(function(list) {
      var readCount = list.issues.filter(function(i) { return i.read; }).length;
      var total = list.issues.length;
      var pct = total > 0 ? Math.round((readCount / total) * 100) : 0;
      var expanded = list.expanded ? 'expanded' : '';
      var sortOrder = list.sortOrder || 'number-asc';
      var sortedIssues = getSortedIssues(list);
      var nextUnread = getNextUnread(list);
      var allRead = readCount === total && total > 0;

      html += '<div class="series-card" data-id="'+list.id+'">';
      html += '<button class="card-delete" data-delete="'+list.id+'" title="Delete list">&times;</button>';

      // Card header
      html += '<div class="card-header" data-toggle="'+list.id+'">';
      html += imgWithFallback(list.image, 56, 80, 'card-cover');
      html += '<div class="card-info">';
      html += '<div class="card-title" title="'+escapeAttr(list.name)+'">'+escapeHTML(list.name)+'</div>';
      html += '<div class="card-progress-text">'+readCount+'/'+total+' read ('+pct+'%)</div>';
      html += '<div class="card-progress-bar"><div class="card-progress-fill" style="width:'+pct+'%"></div></div>';
      html += '</div></div>';

      // Next unread widget (shown when collapsed)
      if (!list.expanded && nextUnread && !allRead) {
        var nextTitle = nextUnread.title ? ' — ' + escapeHTML(nextUnread.title) : '';
        html += '<div class="next-unread-widget" data-list-id="'+list.id+'" data-issue-id="'+nextUnread.id+'">';
        html += imgWithFallback(nextUnread.image, 40, 56, 'next-unread-thumb');
        html += '<div class="next-unread-info">';
        html += '<div class="next-unread-label">Up Next</div>';
        html += '<div class="next-unread-title">#'+escapeHTML(String(nextUnread.number))+nextTitle+'</div>';
        html += '</div>';
        html += '<button class="next-unread-skip" data-quick-skip-list="'+list.id+'" data-quick-skip-issue="'+nextUnread.id+'" title="Skip this issue">';
        html += '<span class="skip-arrow">&#8631;</span> Skip';
        html += '</button>';
        html += '<button class="next-unread-mark" data-quick-read-list="'+list.id+'" data-quick-read-issue="'+nextUnread.id+'" title="Mark as read">';
        html += '<span class="check-icon"></span> Read';
        html += '</button>';
        html += '</div>';
      } else if (!list.expanded && allRead && total > 0) {
        html += '<div class="all-read-message">';
        html += '<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/><path d="M5 8l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        html += ' All issues read!';
        html += '</div>';
      }

      // Toggle bar
      html += '<div class="card-toggle" data-toggle="'+list.id+'">';
      html += '<span class="arrow '+expanded+'">&#9660;</span> '+(expanded ? 'Hide' : 'Show')+' Issues ('+total+')';
      html += '</div>';

      // Issues wrapper
      html += '<div class="issues-wrapper '+expanded+'">';

      // Sort/reorder bar
      html += '<div class="reorder-bar">';
      html += '<label>Sort:</label>';
      html += '<select data-sort-select="'+list.id+'">';
      html += '<option value="number-asc"'+(sortOrder==='number-asc'?' selected':'')+'>Issue # (asc)</option>';
      html += '<option value="number-desc"'+(sortOrder==='number-desc'?' selected':'')+'>Issue # (desc)</option>';
      html += '<option value="unread-first"'+(sortOrder==='unread-first'?' selected':'')+'>Unread first</option>';
      html += '<option value="read-first"'+(sortOrder==='read-first'?' selected':'')+'>Read first</option>';
      html += '<option value="skipped-first"'+(sortOrder==='skipped-first'?' selected':'')+'>Skipped first</option>';
      html += '</select>';
      html += '</div>';

      html += '<div class="issues-list">';

      sortedIssues.forEach(function(issue) {
        var readClass = issue.read ? 'read' : '';
        var skippedClass = issue.skipped ? 'skipped' : '';
        var checked = issue.read ? 'checked' : '';
        var titleText = issue.title ? ' - '+escapeHTML(issue.title) : '';
        var skippedBadge = issue.skipped ? '<span class="skipped-badge">skipped</span>' : '';
        var skipBtnLabel = issue.skipped ? 'Unskip' : 'Skip';
        var skipBtnClass = issue.skipped ? 'issue-skip-btn is-skipped' : 'issue-skip-btn';
        html += '<div class="issue-row '+readClass+' '+skippedClass+'">';
        html += '<label class="issue-checkbox"><input type="checkbox" '+checked+' data-issue="'+issue.id+'" data-list="'+list.id+'"><span class="checkmark"></span></label>';
        html += imgWithFallback(issue.image, 40, 56, 'issue-thumb');
        html += '<span class="issue-text"><span class="issue-number">#'+escapeHTML(String(issue.number))+'</span>'+skippedBadge+titleText+'</span>';
        html += '<button class="'+skipBtnClass+'" data-skip-issue="'+issue.id+'" data-skip-list="'+list.id+'">'+skipBtnLabel+'</button>';
        html += '</div>';
      });

      html += '</div></div></div>';
    });
    html += '</div>';
    main.innerHTML = html;

    bindCardEvents();
  }

  function bindCardEvents() {
    // Toggle expand/collapse
    document.querySelectorAll('[data-toggle]').forEach(function(el) {
      el.addEventListener('click', function(e) {
        if (e.target.closest('[data-delete]') || e.target.closest('.issue-checkbox') || e.target.closest('[data-quick-read-list]') || e.target.closest('[data-quick-skip-list]') || e.target.closest('[data-skip-issue]')) return;
        var listId = this.dataset.toggle;
        var list = state.lists.find(function(l) { return l.id === listId; });
        if (list) {
          list.expanded = !list.expanded;
          saveState();
          render();
        }
      });
    });

    // Issue checkboxes
    document.querySelectorAll('.issue-checkbox input[type="checkbox"]').forEach(function(cb) {
      cb.addEventListener('change', function() {
        var listId = this.dataset.list;
        var issueId = this.dataset.issue;
        var list = state.lists.find(function(l) { return l.id === listId; });
        if (list) {
          var issue = list.issues.find(function(i) { return i.id === issueId; });
          if (issue) {
            issue.read = this.checked;
            saveState();
            render();
          }
        }
      });
    });

    // Quick-read buttons (next unread widget)
    document.querySelectorAll('[data-quick-read-list]').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var listId = this.dataset.quickReadList;
        var issueId = this.dataset.quickReadIssue;
        var list = state.lists.find(function(l) { return l.id === listId; });
        if (!list) return;
        var issue = list.issues.find(function(i) { return i.id === issueId; });
        if (!issue) return;

        // Mark as read
        issue.read = true;
        saveState();

        // Animate the widget before re-render
        var widget = this.closest('.next-unread-widget');
        if (widget) {
          widget.classList.add('marking');
        }

        // Short delay for the animation, then re-render to show next issue
        setTimeout(function() { render(); }, 250);
      });
    });

    // Quick-skip buttons (next unread widget - collapsed view)
    document.querySelectorAll('[data-quick-skip-list]').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var listId = this.dataset.quickSkipList;
        var issueId = this.dataset.quickSkipIssue;
        var list = state.lists.find(function(l) { return l.id === listId; });
        if (!list) return;
        var issue = list.issues.find(function(i) { return i.id === issueId; });
        if (!issue) return;

        issue.skipped = true;
        saveState();

        var widget = this.closest('.next-unread-widget');
        if (widget) widget.classList.add('marking');

        setTimeout(function() { render(); }, 250);
      });
    });

    // Skip/unskip buttons in expanded issue rows
    document.querySelectorAll('[data-skip-issue]').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var listId = this.dataset.skipList;
        var issueId = this.dataset.skipIssue;
        var list = state.lists.find(function(l) { return l.id === listId; });
        if (!list) return;
        var issue = list.issues.find(function(i) { return i.id === issueId; });
        if (!issue) return;

        issue.skipped = !issue.skipped;
        saveState();
        render();
        showToast(issue.skipped ? 'Issue #'+issue.number+' skipped' : 'Issue #'+issue.number+' unskipped');
      });
    });

    // Sort select
    document.querySelectorAll('[data-sort-select]').forEach(function(sel) {
      sel.addEventListener('change', function() {
        var listId = this.dataset.sortSelect;
        var list = state.lists.find(function(l) { return l.id === listId; });
        if (list) {
          list.sortOrder = this.value;
          saveState();
          render();
        }
      });
    });

    // Delete
    document.querySelectorAll('[data-delete]').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var listId = this.dataset.delete;
        var list = state.lists.find(function(l) { return l.id === listId; });
        if (list) {
          pendingDeleteId = listId;
          document.getElementById('deleteConfirmText').textContent =
            'Are you sure you want to delete "'+list.name+'"? This cannot be undone.';
          document.getElementById('deleteConfirm').classList.add('visible');
        }
      });
    });

  }

  // ── SEARCH ──
  var searchInput = document.getElementById('searchInput');
  var searchDropdown = document.getElementById('searchDropdown');

  function debounce(fn, ms) {
    return function() {
      var args = arguments, self = this;
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(function() { fn.apply(self, args); }, ms);
    };
  }

  searchInput.addEventListener('input', debounce(function() {
    var q = searchInput.value.trim();
    if (q.length < 2) { hideDropdown(); return; }
    if (!state.settings.apiKey) {
      showDropdownMessage('Set your Comic Vine API key in Settings to search, or use "Create Manually".');
      return;
    }
    doSearch(q);
  }, 300));

  searchInput.addEventListener('focus', function() {
    var q = searchInput.value.trim();
    if (q.length >= 2 && !state.settings.apiKey) {
      showDropdownMessage('Set your Comic Vine API key in Settings to search, or use "Create Manually".');
    }
  });

  document.addEventListener('click', function(e) {
    if (!e.target.closest('.search-container')) hideDropdown();
  });

  function hideDropdown() {
    searchDropdown.classList.remove('visible');
    searchDropdown.innerHTML = '';
  }

  function showDropdownMessage(msg) {
    searchDropdown.innerHTML = '<div class="search-message">'+escapeHTML(msg)+'</div>';
    searchDropdown.classList.add('visible');
  }

  async function doSearch(query) {
    searchDropdown.innerHTML = '<div class="search-loading"><span class="spinner"></span> Searching...</div>';
    searchDropdown.classList.add('visible');

    try {
      var proxy = 'https://corsproxy.io/?';
      var apiKey = state.settings.apiKey;
      var url = proxy + encodeURIComponent('https://comicvine.gamespot.com/api/search/?api_key='+apiKey+'&format=json&query='+encodeURIComponent(query)+'&resources=volume&limit=10');

      var resp = await fetch(url);
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      var data = await resp.json();

      if (!data.results || data.results.length === 0) {
        showDropdownMessage('No results found. Try a different search or create manually.');
        return;
      }

      var html = '';
      data.results.forEach(function(vol) {
        var imgSrc = vol.image ? (vol.image.icon_url || vol.image.small_url || vol.image.thumb_url || '') : '';
        var startYear = vol.start_year || '?';
        var publisher = vol.publisher ? vol.publisher.name : 'Unknown';
        var count = vol.count_of_issues || '?';
        html += '<div class="search-result-item" data-volume-id="'+vol.id+'" data-volume-name="'+escapeAttr(vol.name + (vol.start_year ? ' ('+vol.start_year+')' : ''))+'" data-volume-image="'+escapeAttr(imgSrc)+'">';
        html += imgWithFallback(imgSrc, 36, 50, 'search-result-img');
        html += '<div class="search-result-info">';
        html += '<div class="search-result-title">'+escapeHTML(vol.name)+'</div>';
        html += '<div class="search-result-meta">'+escapeHTML(publisher)+' &middot; '+startYear+' &middot; '+count+' issues</div>';
        html += '</div></div>';
      });
      searchDropdown.innerHTML = html;
      searchDropdown.classList.add('visible');

      searchDropdown.querySelectorAll('.search-result-item').forEach(function(item) {
        item.addEventListener('click', function() {
          var volId = this.dataset.volumeId;
          var volName = this.dataset.volumeName;
          var volImage = this.dataset.volumeImage;
          hideDropdown();
          searchInput.value = '';
          importVolume(volId, volName, volImage);
        });
      });

    } catch (err) {
      console.error('Search error:', err);
      showDropdownMessage('Search failed. Check your API key and try again, or create a list manually.');
    }
  }

  async function importVolume(volumeId, volumeName, volumeImage) {
    if (state.lists.some(function(l) { return l.source === 'api' && l.apiVolumeId === volumeId; })) {
      showToast('This series is already in your lists.');
      return;
    }

    showToast('Fetching issues...');

    try {
      var proxy = 'https://corsproxy.io/?';
      var apiKey = state.settings.apiKey;
      var allIssues = [];
      var offset = 0;
      var totalResults = 1;

      while (offset < totalResults) {
        var url = proxy + encodeURIComponent('https://comicvine.gamespot.com/api/issues/?api_key='+apiKey+'&format=json&filter=volume:'+volumeId+'&sort=issue_number:asc&offset='+offset+'&limit=100');
        var resp = await fetch(url);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        var data = await resp.json();

        totalResults = data.number_of_total_results || 0;

        if (data.results) {
          data.results.forEach(function(iss) {
            allIssues.push({
              id: uuid(),
              number: iss.issue_number || String(allIssues.length + 1),
              title: iss.name || '',
              image: iss.image ? (iss.image.small_url || iss.image.thumb_url || iss.image.icon_url || null) : null,
              read: false,
              skipped: false
            });
          });
        }

        offset += 100;
        if (!data.results || data.results.length === 0) break;
      }

      if (allIssues.length === 0) {
        showToast('No issues found for this volume.');
        return;
      }

      var newList = {
        id: uuid(),
        name: volumeName,
        image: volumeImage || null,
        source: 'api',
        apiVolumeId: volumeId,
        issues: allIssues,
        dateAdded: new Date().toISOString(),
        expanded: false,
        sortOrder: 'number-asc'
      };

      state.lists.unshift(newList);
      saveState();
      render();
      showToast('Added "'+volumeName+'" with '+allIssues.length+' issues');

    } catch (err) {
      console.error('Import error:', err);
      showToast('Failed to fetch issues. Try again or create the list manually.');
    }
  }

  // ── MANUAL CREATION ──
  var manualModal = document.getElementById('manualModal');
  var btnCreateManual = document.getElementById('btnCreateManual');

  function openManualModal() {
    manualIssues = [];
    document.getElementById('manualName').value = '';
    document.getElementById('manualImage').value = '';
    document.getElementById('rangeStart').value = '';
    document.getElementById('rangeEnd').value = '';
    document.getElementById('singleNumber').value = '';
    document.getElementById('singleTitle').value = '';
    document.getElementById('singleCover').value = '';
    renderPreviewIssues();
    manualModal.classList.add('visible');
    setTimeout(function() { document.getElementById('manualName').focus(); }, 100);
  }

  function closeManualModal() { manualModal.classList.remove('visible'); }

  btnCreateManual.addEventListener('click', openManualModal);
  document.getElementById('manualModalClose').addEventListener('click', closeManualModal);
  document.getElementById('manualCancel').addEventListener('click', closeManualModal);
  manualModal.addEventListener('click', function(e) { if (e.target === manualModal) closeManualModal(); });

  document.getElementById('btnAddRange').addEventListener('click', function() {
    var start = parseInt(document.getElementById('rangeStart').value, 10);
    var end = parseInt(document.getElementById('rangeEnd').value, 10);
    if (isNaN(start) || isNaN(end) || start < 1 || end < start) {
      showToast('Enter valid start and end numbers (start must be less than or equal to end).');
      return;
    }
    if (end - start > 500) {
      showToast('Range too large. Maximum 500 issues at once.');
      return;
    }
    for (var i = start; i <= end; i++) {
      if (!manualIssues.some(function(mi) { return String(mi.number) === String(i); })) {
        manualIssues.push({ id: uuid(), number: String(i), title: '', image: null, read: false, skipped: false });
      }
    }
    manualIssues.sort(function(a, b) { return (parseFloat(a.number)||0) - (parseFloat(b.number)||0); });
    renderPreviewIssues();
    document.getElementById('rangeStart').value = '';
    document.getElementById('rangeEnd').value = '';
    showToast('Added issues #'+start+'-#'+end);
  });

  document.getElementById('btnAddSingle').addEventListener('click', function() {
    var num = document.getElementById('singleNumber').value.trim();
    var title = document.getElementById('singleTitle').value.trim();
    var cover = document.getElementById('singleCover').value.trim();
    if (!num) { showToast('Enter an issue number.'); return; }
    if (manualIssues.some(function(mi) { return String(mi.number) === num; })) {
      showToast('Issue #'+num+' already added.');
      return;
    }
    manualIssues.push({ id: uuid(), number: num, title: title, image: cover || null, read: false, skipped: false });
    manualIssues.sort(function(a, b) { return (parseFloat(a.number)||0) - (parseFloat(b.number)||0); });
    renderPreviewIssues();
    document.getElementById('singleNumber').value = '';
    document.getElementById('singleTitle').value = '';
    document.getElementById('singleCover').value = '';
    document.getElementById('singleNumber').focus();
  });

  function renderPreviewIssues() {
    var container = document.getElementById('previewIssues');
    if (manualIssues.length === 0) {
      container.innerHTML = '<p style="color:var(--text-muted);font-size:0.84rem;padding:8px;">No issues added yet.</p>';
      return;
    }
    var html = '';
    manualIssues.forEach(function(iss, idx) {
      var titleText = iss.title ? ' - '+escapeHTML(iss.title) : '';
      html += '<div class="preview-issue">';
      html += '<span style="font-weight:600;color:var(--text-primary);">#'+escapeHTML(String(iss.number))+'</span>';
      html += '<span style="color:var(--text-secondary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+titleText+'</span>';
      html += '<button class="remove-issue" data-idx="'+idx+'">&times;</button>';
      html += '</div>';
    });
    container.innerHTML = html;

    container.querySelectorAll('.remove-issue').forEach(function(btn) {
      btn.addEventListener('click', function() {
        manualIssues.splice(parseInt(this.dataset.idx, 10), 1);
        renderPreviewIssues();
      });
    });
  }

  document.getElementById('manualCreate').addEventListener('click', function() {
    var name = document.getElementById('manualName').value.trim();
    var image = document.getElementById('manualImage').value.trim();

    if (!name) {
      showToast('Please enter a series name.');
      document.getElementById('manualName').focus();
      return;
    }
    if (manualIssues.length === 0) {
      showToast('Please add at least one issue.');
      return;
    }

    var newList = {
      id: uuid(),
      name: name,
      image: image || null,
      source: 'manual',
      issues: manualIssues.map(function(i) { return Object.assign({}, i); }),
      dateAdded: new Date().toISOString(),
      expanded: false,
      sortOrder: 'number-asc'
    };

    state.lists.unshift(newList);
    saveState();
    closeManualModal();
    render();
    showToast('Created "'+name+'" with '+manualIssues.length+' issues');
  });

  // ── SETTINGS ──
  var settingsModal = document.getElementById('settingsModal');

  document.getElementById('btnSettings').addEventListener('click', function() {
    document.getElementById('apiKeyInput').value = state.settings.apiKey || '';
    settingsModal.classList.add('visible');
    setTimeout(function() { document.getElementById('apiKeyInput').focus(); }, 100);
  });

  document.getElementById('settingsModalClose').addEventListener('click', function() { settingsModal.classList.remove('visible'); });
  document.getElementById('settingsCancel').addEventListener('click', function() { settingsModal.classList.remove('visible'); });
  settingsModal.addEventListener('click', function(e) { if (e.target === settingsModal) settingsModal.classList.remove('visible'); });

  document.getElementById('settingsSave').addEventListener('click', function() {
    state.settings.apiKey = document.getElementById('apiKeyInput').value.trim();
    saveState();
    settingsModal.classList.remove('visible');
    showToast('Settings saved');
  });

  // ── EXPORT ──
  document.getElementById('btnExport').addEventListener('click', function() {
    var dataStr = JSON.stringify(state, null, 2);
    var blob = new Blob([dataStr], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    var date = new Date().toISOString().split('T')[0];
    a.href = url;
    a.download = 'comic-tracker-backup-'+date+'.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Backup exported');
  });

  // ── IMPORT ──
  document.getElementById('btnImport').addEventListener('click', function() {
    document.getElementById('importInput').click();
  });

  document.getElementById('importInput').addEventListener('change', function(e) {
    var file = e.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
      try {
        var data = JSON.parse(ev.target.result);
        if (!data || !Array.isArray(data.lists)) {
          showToast('Invalid backup file format.');
          return;
        }
        pendingImportData = data;
        if (state.lists.length > 0) {
          document.getElementById('importConfirm').classList.add('visible');
        } else {
          doImport('replace');
        }
      } catch (err) {
        showToast('Failed to parse backup file.');
      }
    };
    reader.readAsText(file);
    this.value = '';
  });

  document.getElementById('importCancel').addEventListener('click', function() {
    document.getElementById('importConfirm').classList.remove('visible');
    pendingImportData = null;
  });

  document.getElementById('importMerge').addEventListener('click', function() {
    document.getElementById('importConfirm').classList.remove('visible');
    doImport('merge');
  });

  document.getElementById('importReplace').addEventListener('click', function() {
    document.getElementById('importConfirm').classList.remove('visible');
    doImport('replace');
  });

  function doImport(mode) {
    if (!pendingImportData) return;

    if (mode === 'replace') {
      state.lists = pendingImportData.lists || [];
      if (pendingImportData.settings) {
        state.settings = Object.assign({}, state.settings, pendingImportData.settings);
      }
    } else {
      var existingIds = {};
      state.lists.forEach(function(l) { existingIds[l.id] = true; });
      (pendingImportData.lists || []).forEach(function(list) {
        if (!existingIds[list.id]) {
          state.lists.push(list);
        } else {
          var existing = state.lists.find(function(l) { return l.id === list.id; });
          if (existing) {
            var existingIssueIds = {};
            existing.issues.forEach(function(i) { existingIssueIds[i.id] = true; });
            list.issues.forEach(function(iss) {
              if (!existingIssueIds[iss.id]) existing.issues.push(iss);
            });
          }
        }
      });
      if (pendingImportData.settings && pendingImportData.settings.apiKey && !state.settings.apiKey) {
        state.settings.apiKey = pendingImportData.settings.apiKey;
      }
    }

    // Ensure sortOrder and skipped migration
    state.lists.forEach(function(list) {
      if (!list.sortOrder) list.sortOrder = 'number-asc';
      if (list.sortOrder === 'title-asc' || list.sortOrder === 'title-desc') list.sortOrder = 'number-asc';
      list.issues.forEach(function(iss) {
        if (typeof iss.skipped === 'undefined') iss.skipped = false;
      });
    });

    pendingImportData = null;
    saveState();
    render();
    showToast('Data imported ('+mode+')');
  }

  // ── DELETE CONFIRMATION ──
  document.getElementById('deleteCancel').addEventListener('click', function() {
    document.getElementById('deleteConfirm').classList.remove('visible');
    pendingDeleteId = null;
  });

  document.getElementById('deleteYes').addEventListener('click', function() {
    if (pendingDeleteId) {
      var found = state.lists.find(function(l) { return l.id === pendingDeleteId; });
      var name = found ? found.name : 'List';
      state.lists = state.lists.filter(function(l) { return l.id !== pendingDeleteId; });
      saveState();
      render();
      showToast('"'+name+'" deleted');
    }
    document.getElementById('deleteConfirm').classList.remove('visible');
    pendingDeleteId = null;
  });

  // Close confirm dialogs on overlay click
  document.getElementById('importConfirm').addEventListener('click', function(e) {
    if (e.target === this) { this.classList.remove('visible'); pendingImportData = null; }
  });
  document.getElementById('deleteConfirm').addEventListener('click', function(e) {
    if (e.target === this) { this.classList.remove('visible'); pendingDeleteId = null; }
  });

  // ── KEYBOARD SHORTCUTS ──
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      manualModal.classList.remove('visible');
      settingsModal.classList.remove('visible');
      document.getElementById('importConfirm').classList.remove('visible');
      document.getElementById('deleteConfirm').classList.remove('visible');
      hideDropdown();
    }
  });

  // ── INITIAL RENDER ──
  render();

})();
</script>
<script>
// Register Service Worker for PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js').then(function(reg) {
      console.log('Service Worker registered, scope:', reg.scope);
    }).catch(function(err) {
      console.log('Service Worker registration failed:', err);
    });
  });
}
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"75124c326cb447fe934cde04713ae013","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
